# WSL2 ディスク容量最適化ツール

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![PowerShell](https://img.shields.io/badge/PowerShell-5.1%2B-blue.svg)](https://docs.microsoft.com/ja-jp/powershell/)
[![Platform](https://img.shields.io/badge/Platform-Windows-lightgrey.svg)](https://www.microsoft.com/ja-jp/windows)
[![WSL2](https://img.shields.io/badge/WSL2-Compatible-green.svg)](https://docs.microsoft.com/ja-jp/windows/wsl/)

## 概要

WSL2 ディスク容量最適化ツールは、Windows Subsystem for Linux 2 (WSL2) 環境のディスク容量問題を解決するPowerShellベースの自動化ツールです。このツールは、WSL2の`ext4.vhdx`ファイルを自動的に検出・圧縮し、ホストWindowsシステムのディスク容量を回復します。

## クイックスタート

**簡単3ステップ**でWSL2のディスク容量を解放：

1. **ダウンロード**: 最新リリースをダウンロードまたはリポジトリをクローン
2. **管理者として実行**: `WSL2-DiskOptimizer.bat`を実行
3. **待機**: ツールが自動的にWSL2ディスクボリュームを最適化

```cmd
# リポジトリをクローン
git clone https://github.com/kyto64/WSL2_Disk_Volume_Optimizer.git
cd WSL2_Disk_Volume_Optimizer

# 最適化ツールを実行（管理者権限が必要）
WSL2-DiskOptimizer.bat
```

> ⚠️ **重要**: このツールを実行する前に、必ずWSL環境をバックアップしてください！

## 課題と背景

WSL2環境では以下の問題が発生することがあります：
- `ext4.vhdx`仮想ディスクファイルが時間の経過とともに肥大化し、WSL内でファイルを削除しても縮小されない
- 手動での`diskpart`操作は時間がかかり、エラーが発生しやすい
- Dockerコンテナとイメージが WSL内で大量のディスク容量を消費する
- システム管理者がディスク容量管理の自動化ソリューションを必要とする

## ソリューション機能

このツールは以下を提供します：
- 標準インストールパス全体でのWSL2 VHDファイルの自動検出
- `Optimize-VHD`コマンドレットまたはフォールバックとしての`diskpart`を使用したインテリジェント圧縮
- 包括的なエラーハンドリングとロギング
- 異なる運用要件に対応する複数の実行方法

## 技術仕様

### システム要件
- WSL2が有効化されたWindows 10/11
- PowerShell 5.1以上
- 管理者権限
- 標準Windows `diskpart`ユーティリティ

### サポート環境
- 全てのWSL2ディストリビューション
- WSL2バックエンドを使用するDocker Desktop for Windows
- 企業および個人のWindows環境

## インストールと展開

### 前提条件
1. WSL2が適切にインストール・設定されていることを確認
2. PowerShellの実行ポリシーがスクリプト実行を許可していることを確認
3. 対象システムで管理者権限を取得

### ファイル構成
```
WSL2_Disk_Volume_Optimizer/
├── Optimize-WSL2Disk.ps1      # メインのVHD最適化PowerShellスクリプト
├── WSL2-DiskOptimizer.bat     # 対話型バッチラッパー（簡単実行用）
├── README.md                  # 英語版ドキュメント
├── README-JP.md               # 日本語版ドキュメント（このファイル）
└── LICENSE                    # MITライセンス条項
```

#### ファイル説明

- **`Optimize-WSL2Disk.ps1`**: 実際のVHD圧縮を実行するメインのPowerShellスクリプト。WSL2 VHDファイルの検出、WSLサービスの停止、圧縮操作の実行などのコアロジックが含まれています。

- **`WSL2-DiskOptimizer.bat`**: ユーザーフレンドリーなバッチファイルラッパーで、対話型インターフェースを提供します。管理者権限のチェックや実行中の明確なフィードバックを処理します。

- **`README.md`**: インストール、使用法、トラブルシューティング、ベストプラクティスを含む包括的な英語版ドキュメント。

- **`README-JP.md`**: 日本語ユーザー向けのドキュメントの完全な日本語翻訳版。

- **`LICENSE`**: 使用および配布の条件を規定するMITライセンスファイル。

## 運用手順

### 方法1: 対話型実行（本番環境推奨）

1. 管理者権限でコマンドプロンプトを開く
2. ツールディレクトリに移動
3. 対話型バッチファイルを実行：
   ```cmd
   WSL2-DiskOptimizer.bat
   ```
4. VHD圧縮を実行

### 方法2: 直接PowerShell実行

既存の自動化フレームワークとの統合用：
```powershell
# VHD圧縮
.\Optimize-WSL2Disk.ps1

# 確認プロンプトを抑制
.\Optimize-WSL2Disk.ps1 -Force
```

### サンプル出力

典型的な実行では以下のような出力が表示されます：

```
[2024-10-01 14:30:00] [INFO] WSL2ディスク容量最適化ツールを開始
[2024-10-01 14:30:00] [INFO] 管理者権限を確認
[2024-10-01 14:30:01] [INFO] WSLをシャットダウン中...
[2024-10-01 14:30:03] [SUCCESS] WSLシャットダウン完了
[2024-10-01 14:30:03] [INFO] VHDファイルを検索中...
[2024-10-01 14:30:04] [INFO] VHDを発見: C:\Users\username\AppData\Local\Packages\CanonicalGroupLimited.Ubuntu_79rhkp1fndgsc\LocalState\ext4.vhdx
[2024-10-01 14:30:04] [INFO] 元のサイズ: 45.2 GB
[2024-10-01 14:30:04] [INFO] VHDを圧縮中...
[2024-10-01 14:32:15] [SUCCESS] 圧縮完了
[2024-10-01 14:32:15] [INFO] 新しいサイズ: 12.8 GB
[2024-10-01 14:32:15] [SUCCESS] 回復した容量: 32.4 GB (71.7%削減)
[2024-10-01 14:32:15] [SUCCESS] 最適化が正常に完了しました
```

## 処理フロー

### フェーズ1: 準備
1. 管理者権限の検証
2. WSL状態の評価
3. 必要ファイルの存在確認
4. ユーザー確認（`-Force`パラメータが指定されていない場合）

### フェーズ2: WSL管理
1. 全WSLディストリビューションの正常なシャットダウン
2. プロセス終了の確認
3. ファイルシステムロック解除の確認

### フェーズ3: VHD最適化
1. 標準ロケーションでの`ext4.vhdx`ファイルの自動検出：
   - `%LOCALAPPDATA%\Packages`
   - `%LOCALAPPDATA%\Docker`
2. `Optimize-VHD`コマンドレットを使用した圧縮試行
3. `Optimize-VHD`が利用できない場合の`diskpart`へのフォールバック
4. サイズ比較と容量回復計算

### フェーズ4: 検証とレポート
1. 処理完了ステータス
2. 容量回復メトリクス
3. 操作成功/失敗の概要
4. 検証のための推奨事項

## 期待される結果

### パフォーマンス向上
- ディスク容量回復: 通常、元のVHDサイズの20-80%
- ファイル断片化の減少によるI/Oパフォーマンス向上
- WSL起動時間の短縮
- システム応答性の改善

### 定量的結果
実行前後の比較例：
```
最適化前:
Filesystem      Size  Used Avail Use% Mounted on
/dev/sdb        250G  180G   57G  76% /

最適化後:
Filesystem      Size  Used Avail Use% Mounted on
/dev/sdb        250G   45G  193G  19% /
```

## リスク評価と軽減策

### 重要な警告
- **データ損失リスク**: 不適切な実行によりWSL環境が破損する可能性があります
- **システム可用性**: 最適化中はWSLサービスが一時的に利用不可になります
- **復旧要件**: 実行前のWSL環境の完全バックアップが必須です

### 軽減策
1. **必須バックアップ**: 最適化前にWSLエクスポートを実行
2. **テストプロトコル**: 本番環境以外で最初に検証
3. **ロールバック計画**: 検証済みバックアップと復旧手順の維持
4. **監視**: 最適化後のWSL機能確認

## トラブルシューティングガイド

### 一般的な問題と解決方法

| 問題 | 原因 | 解決方法 |
|------|------|----------|
| "Optimize-VHD が見つからない" | Windowsエディションの制限 | 期待される動作；ツールは自動的にdiskpartを使用 |
| "管理者権限が必要" | 権限不足 | 管理者として実行 |
| "WSLディストリビューションが起動しない" | 最適化失敗 | バックアップから復元 |

### 診断コマンド
```powershell
# WSL状態の確認
wsl --list --verbose

# ディスク使用量チェック
wsl -d <ディストリビューション> -- df -h

# ファイル整合性の検証
wsl -d <ディストリビューション> -- fsck /dev/sdb
```

## メンテナンスとサポート

### 定期運用
- 定期実行のスケジュール設定（月次推奨）
- ディスク容量トレンドの監視
- 最新バックアップの維持
- 実行ログの異常確認

### バージョン管理
このツールは、セマンティックバージョニングを使用してGitバージョン管理下で維持されています。

### サポートチャネル
- バグ報告用GitHub Issues
- 貢献用Pull Requests
- リポジトリ経由のドキュメント更新

## コンプライアンスとライセンス

このソフトウェアはMITライセンスの下で配布され、以下を提供します：
- 商用利用許可
- 修正権限
- 配布承認
- 私的使用許可

### 免責事項
このツールは「現状のまま」保証なしで提供されます。ユーザーは以下について完全な責任を負います：
- データのバックアップと復旧
- 適切な環境でのテスト
- 組織ポリシーへの準拠
- リスク評価と軽減

## 参考資料とドキュメント

- [Microsoft WSL ドキュメント](https://docs.microsoft.com/ja-jp/windows/wsl/)
- [PowerShell ドキュメント](https://docs.microsoft.com/ja-jp/powershell/)
- [元の解決方法リファレンス](https://qiita.com/siruku6/items/c91a40d460095013540d)

## よくある質問

### Q: このツールはどのくらいの頻度で実行すべきですか？
A: 使用状況にもよりますが、月次実行を推奨します。Dockerを頻繁に使用する環境では、より頻繁な実行が有効な場合があります。

### Q: 企業環境で使用しても安全ですか？
A: はい、ただし事前に非本番環境でのテストと、適切なバックアップ戦略の実装が必要です。

### Q: 実行時間はどのくらいかかりますか？
A: VHDファイルのサイズによりますが、通常5-30分程度です。大きなファイル（100GB以上）の場合は1時間以上かかることもあります。

### Q: ネットワークドライブ上のWSLで使用できますか？
A: いいえ、このツールはローカルディスク上のWSLインストールのみをサポートします。

---

**重要**: 本番環境でこのツールを実行する前に、WSL環境の完全バックアップを確実に取得してください。
